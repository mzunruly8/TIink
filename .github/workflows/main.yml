<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Linko: Euphoria Neon</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;800&display=swap');
        
        body {
            background: #040406;
            color: #ffffff;
            font-family: 'Plus Jakarta Sans', sans-serif;
            overflow: hidden;
            touch-action: none;
            position: fixed;
            width: 100%;
            height: 100%;
        }

        .grid-cell {
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border-radius: 6px;
            box-shadow: inset 0 0 8px rgba(0,0,0,0.3);
        }

        .linking {
            transform: scale(0.8);
            z-index: 50;
            filter: brightness(1.4) saturate(1.2);
            box-shadow: 0 0 25px currentColor;
        }

        .target-tile {
            position: relative;
            border: 2px solid #fff !important;
            animation: targetFloat 0.6s infinite alternate ease-in-out;
            box-shadow: 0 0 20px #fff;
        }

        .target-tile::after {
            content: 'âœ¦';
            font-size: 14px;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .prism-tile {
            background: linear-gradient(45deg, #ff00cc, #3333ff, #00ffcc, #ffff00) !important;
            background-size: 300% 300% !important;
            animation: rainbowFlow 2s linear infinite;
        }

        @keyframes targetFloat { from { transform: scale(1.05); } to { transform: scale(0.9); } }
        @keyframes rainbowFlow { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        .score-text {
            background: linear-gradient(to bottom, #fff, #a5b4fc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .dashboard-glass {
            background: rgba(15, 15, 25, 0.95);
            backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .mode-btn.active {
            border-color: #6366f1;
            background: rgba(99, 102, 241, 0.2);
        }

        #progress-bar {
            transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .stat-card {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.05);
            padding: 10px;
            border-radius: 12px;
            text-align: center;
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen">

    <!-- START MENU -->
    <div id="start-menu" class="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black">
        <div class="dashboard-glass w-full max-w-md rounded-[2.5rem] p-8 flex flex-col gap-6 shadow-2xl">
            <div class="text-center">
                <h1 class="text-5xl font-extrabold tracking-tight score-text mb-1 italic">LINKO</h1>
                <p class="text-[9px] tracking-[0.5em] text-white/30 uppercase">Hyper-Sensory Uplink</p>
            </div>

            <!-- PLAYER STATS PANEL -->
            <div id="stats-panel" class="grid grid-cols-3 gap-2 opacity-50 transition-opacity">
                <div class="stat-card">
                    <span class="block text-[8px] uppercase text-white/40 tracking-tighter">Total Score</span>
                    <span id="stat-total-score" class="text-xs font-bold text-indigo-400">0</span>
                </div>
                <div class="stat-card">
                    <span class="block text-[8px] uppercase text-white/40 tracking-tighter">Max Level</span>
                    <span id="stat-max-level" class="text-xs font-bold text-indigo-400">1</span>
                </div>
                <div class="stat-card">
                    <span class="block text-[8px] uppercase text-white/40 tracking-tighter">Rank</span>
                    <span id="stat-rank" class="text-xs font-bold text-indigo-400">D</span>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <button onclick="setMode('standard', this)" class="mode-btn active border border-white/10 bg-white/5 p-4 rounded-2xl text-center transition-all">
                    <span class="block text-indigo-400 font-bold uppercase text-xs">Zen</span>
                    <span class="text-[9px] text-white/40">5 Min</span>
                </button>
                <button onclick="setMode('blitz', this)" class="mode-btn border border-white/10 bg-white/5 p-4 rounded-2xl text-center transition-all">
                    <span class="block text-rose-400 font-bold uppercase text-xs">Rush</span>
                    <span class="text-[9px] text-white/40">1 Min</span>
                </button>
            </div>

            <input type="text" id="player-name" maxlength="8" class="bg-white/5 p-4 rounded-xl text-center text-lg font-bold uppercase outline-none border border-white/10 focus:border-indigo-500" value="PILOT_00">

            <button id="launch-btn" disabled onclick="startGame()" class="w-full bg-white text-black py-5 rounded-2xl font-extrabold text-xl uppercase tracking-widest active:scale-95 transition-all disabled:opacity-20">
                Connect
            </button>
        </div>
    </div>

    <!-- GAMEPLAY UI -->
    <div id="game-ui" class="hidden w-full max-w-md flex flex-col items-center p-4">
        <div class="w-full flex justify-between items-end mb-4 px-2">
            <div class="flex flex-col">
                <div class="flex items-baseline gap-2">
                    <div id="score" class="text-4xl font-extrabold score-text italic leading-none">000000</div>
                    <div class="text-[10px] text-white/30 font-bold">/ <span id="target-score">1000</span></div>
                </div>
                <div id="ui-player" class="text-[9px] font-bold text-indigo-400 tracking-[0.3em] uppercase mt-2">PILOT_00</div>
            </div>
            <div class="text-right">
                <div id="timer-text" class="text-2xl font-extrabold tabular-nums opacity-90">05:00</div>
                <div id="ui-level" class="text-[10px] uppercase tracking-widest text-indigo-400 font-black">LEVEL 01</div>
            </div>
        </div>

        <!-- Level Progress -->
        <div class="w-full h-1.5 bg-white/5 rounded-full mb-6 overflow-hidden border border-white/5">
            <div id="progress-bar" class="h-full bg-indigo-500 w-0 shadow-[0_0_10px_#6366f1]"></div>
        </div>

        <div id="board-container" class="relative w-full aspect-square bg-white/[0.03] rounded-[1.5rem] p-2 border border-white/10">
            <div id="main-board" class="grid grid-cols-12 gap-1 h-full w-full"></div>
            <div id="cancel-alert" class="absolute inset-0 flex items-center justify-center pointer-events-none opacity-0 bg-rose-600/40 rounded-[1.5rem] transition-opacity duration-300">
                <span class="text-white font-black text-2xl tracking-tighter uppercase italic">Abort Link</span>
            </div>
        </div>

        <div class="w-full flex justify-between mt-6 px-2">
            <button onclick="saveProgress()" class="text-[10px] font-bold text-white/40 uppercase tracking-widest hover:text-white transition-colors">Manual Save</button>
            <div id="save-status" class="text-[10px] font-bold text-indigo-400 uppercase tracking-widest opacity-0 transition-opacity">Cloud Synced</div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const GRID_SIZE = 12;
        const TOTAL_CELLS = GRID_SIZE * GRID_SIZE;
        const COLORS = ['#FF007A', '#00E5FF', '#7000FF', '#FFD600', '#00FF94'];
        
        const state = {
            mode: 'standard', 
            score: 0, 
            level: 1,
            targetScore: 1000,
            timeLeft: 300, 
            isDragging: false, 
            currentLink: [], 
            isProcessing: false, 
            timerId: null, 
            cancelPending: false, 
            isSquare: false,
            user: null
        };

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'linko-euphoria-v2';

        const initAuth = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        };

        initAuth();

        onAuthStateChanged(auth, async (user) => { 
            if(user) {
                state.user = user;
                document.getElementById('launch-btn').disabled = false;
                await loadProgress();
            }
        });

        async function saveProgress() {
            if (!state.user) return;
            try {
                const saveRef = doc(db, 'artifacts', appId, 'users', state.user.uid, 'profile', 'progress');
                await setDoc(saveRef, {
                    score: state.score,
                    level: state.level,
                    targetScore: state.targetScore,
                    playerName: document.getElementById('player-name').value,
                    updatedAt: Date.now()
                });
                updateStatsPanel();
                showSaveStatus();
            } catch (e) { console.error(e); }
        }

        async function loadProgress() {
            if (!state.user) return;
            const saveRef = doc(db, 'artifacts', appId, 'users', state.user.uid, 'profile', 'progress');
            const snap = await getDoc(saveRef);
            if (snap.exists()) {
                const data = snap.data();
                state.score = data.score || 0;
                state.level = data.level || 1;
                state.targetScore = data.targetScore || 1000;
                document.getElementById('player-name').value = data.playerName || 'PILOT_00';
                updateUI();
                updateStatsPanel();
            }
        }

        function updateStatsPanel() {
            document.getElementById('stats-panel').style.opacity = '1';
            document.getElementById('stat-total-score').innerText = state.score.toLocaleString();
            document.getElementById('stat-max-level').innerText = state.level;
            
            let rank = 'D';
            if (state.score > 50000) rank = 'A';
            else if (state.score > 25000) rank = 'B';
            else if (state.score > 10000) rank = 'C';
            document.getElementById('stat-rank').innerText = rank;
        }

        function showSaveStatus() {
            const el = document.getElementById('save-status');
            el.style.opacity = '1';
            setTimeout(() => el.style.opacity = '0', 2000);
        }

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playTone(f, d, t='sine', v=0.04) {
            const osc = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            osc.type = t; osc.frequency.setValueAtTime(f, audioCtx.currentTime);
            g.gain.setValueAtTime(v, audioCtx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + d);
            osc.connect(g); g.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + d);
        }

        window.setMode = (m, el) => {
            state.mode = m;
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            el.classList.add('active');
            playTone(440, 0.1);
        };

        window.startGame = () => {
            document.getElementById('start-menu').classList.add('hidden');
            document.getElementById('game-ui').classList.remove('hidden');
            document.getElementById('ui-player').innerText = document.getElementById('player-name').value.toUpperCase();
            state.timeLeft = state.mode === 'blitz' ? 60 : 300;
            initGrid();
            state.timerId = setInterval(tick, 1000);
            updateUI();
        };

        function initGrid() {
            const b = document.getElementById('main-board');
            b.innerHTML = '';
            for (let i = 0; i < TOTAL_CELLS; i++) {
                const cell = document.createElement('div');
                cell.className = 'grid-cell flex items-center justify-center cursor-pointer';
                cell.dataset.index = i;
                randomizeCell(cell);
                cell.addEventListener('mousedown', (e) => startLink(e, cell));
                cell.addEventListener('mouseenter', (e) => continueLink(e, cell));
                b.appendChild(cell);
            }
        }

        function randomizeCell(cell) {
            cell.classList.remove('prism-tile', 'target-tile');
            if (Math.random() < 0.05) {
                cell.dataset.color = 'prism'; cell.classList.add('prism-tile'); cell.style.backgroundColor = '';
            } else {
                const idx = Math.floor(Math.random() * COLORS.length);
                cell.dataset.color = idx; cell.style.backgroundColor = COLORS[idx];
                cell.style.boxShadow = `inset 0 0 10px ${COLORS[idx]}55`;
            }
        }

        function startLink(e, cell) {
            if (state.isProcessing) return;
            state.isDragging = true; state.cancelPending = false; state.isSquare = false;
            state.currentLink = [cell]; cell.classList.add('linking');
            playTone(261, 0.1, 'triangle');
        }

        function continueLink(e, cell) {
            if (!state.isDragging || state.isProcessing || state.cancelPending) return;
            const last = state.currentLink[state.currentLink.length - 1];
            if (last === cell) return;

            if (state.currentLink.includes(cell)) {
                if (state.currentLink.length >= 4 && !state.isSquare) {
                    state.isSquare = true; cell.classList.add('target-tile');
                    playTone(523, 0.2, 'square', 0.02);
                }
                return;
            }

            const i1 = parseInt(last.dataset.index), i2 = parseInt(cell.dataset.index);
            const r1 = Math.floor(i1/GRID_SIZE), c1 = i1 % GRID_SIZE, r2 = Math.floor(i2/GRID_SIZE), c2 = i2 % GRID_SIZE;
            if (Math.abs(r1-r2) <= 1 && Math.abs(c1-c2) <= 1) {
                if (cell.dataset.color === 'prism' || last.dataset.color === 'prism' || cell.dataset.color === last.dataset.color) {
                    state.currentLink.push(cell); cell.classList.add('linking');
                    playTone(261 + (state.currentLink.length * 20), 0.05, 'triangle');
                }
            }
        }

        async function resolveLink() {
            if (state.cancelPending || state.currentLink.length < 3) { abortLink(); return; }
            state.isProcessing = true;

            if (state.isSquare) {
                const targetColor = state.currentLink.find(c => c.dataset.color !== 'prism')?.dataset.color;
                if (targetColor !== undefined) {
                    document.querySelectorAll('.grid-cell').forEach(c => { if (c.dataset.color === targetColor) c.dataset.mark = 'true'; });
                    playTone(100, 0.4, 'sawtooth', 0.05);
                }
            }

            state.score += (state.currentLink.length * 100) * (state.isSquare ? 2 : 1);
            state.currentLink.forEach(c => c.dataset.mark = 'true');
            
            document.querySelectorAll('[data-mark="true"]').forEach(c => {
                c.style.opacity = '0'; c.style.transform = 'scale(1.2)';
            });

            await new Promise(r => setTimeout(r, 150));
            applyGravity();
            checkLevelUp();
            state.isSquare = false; state.isProcessing = false;
            updateUI();
        }

        function checkLevelUp() {
            if (state.score >= state.targetScore) {
                state.level++;
                state.targetScore = Math.floor(state.targetScore * 1.8);
                playTone(880, 0.4, 'sine', 0.1);
                saveProgress();
            }
        }

        function abortLink() {
            state.currentLink.forEach(c => c.classList.remove('linking', 'target-tile'));
            state.currentLink = []; state.cancelPending = false; state.isSquare = false;
            document.getElementById('cancel-alert').style.opacity = '0';
        }

        function applyGravity() {
            const cells = Array.from(document.getElementById('main-board').children);
            for (let x = 0; x < GRID_SIZE; x++) {
                const col = cells.filter((_, i) => i % GRID_SIZE === x);
                let gap = 0;
                for (let y = GRID_SIZE - 1; y >= 0; y--) {
                    if (col[y].dataset.mark === 'true') { gap++; col[y].dataset.mark = 'false'; }
                    else if (gap > 0) {
                        const target = col[y + gap];
                        target.dataset.color = col[y].dataset.color;
                        target.style.backgroundColor = col[y].style.backgroundColor;
                        if (col[y].classList.contains('prism-tile')) target.classList.add('prism-tile');
                        else target.classList.remove('prism-tile');
                        col[y].dataset.mark = 'true';
                    }
                }
                for (let y = 0; y < gap; y++) {
                    const c = col[y]; c.style.opacity = '1'; c.style.transform = 'scale(1)';
                    c.classList.remove('linking', 'target-tile'); randomizeCell(c);
                }
                col.forEach(c => {
                    c.style.opacity = '1'; c.style.transform = 'scale(1)';
                    c.classList.remove('linking', 'target-tile'); c.dataset.mark = 'false';
                });
            }
        }

        function tick() {
            state.timeLeft--;
            if (state.timeLeft <= 0) { 
                clearInterval(state.timerId); 
                saveProgress();
                location.reload(); 
            }
            updateUI();
        }

        function updateUI() {
            document.getElementById('score').innerText = state.score.toString().padStart(6, '0');
            document.getElementById('target-score').innerText = state.targetScore;
            document.getElementById('ui-level').innerText = `LEVEL ${state.level.toString().padStart(2, '0')}`;
            
            const m = Math.floor(state.timeLeft / 60), s = state.timeLeft % 60;
            document.getElementById('timer-text').innerText = `${m}:${s.toString().padStart(2, '0')}`;
            
            const progress = (state.score / state.targetScore) * 100;
            document.getElementById('progress-bar').style.width = `${Math.min(progress, 100)}%`;
        }

        const handleDrag = (y) => {
            if (!state.isDragging) return;
            const b = document.getElementById('board-container').getBoundingClientRect();
            if (y > b.bottom + 20) {
                if (!state.cancelPending) { state.cancelPending = true; document.getElementById('cancel-alert').style.opacity = '1'; }
            } else { state.cancelPending = false; document.getElementById('cancel-alert').style.opacity = '0'; }
        };

        window.addEventListener('mousemove', (e) => handleDrag(e.clientY));
        window.addEventListener('touchmove', (e) => handleDrag(e.touches[0].clientY), { passive: false });
        window.addEventListener('mouseup', () => { if (state.isDragging) { state.isDragging = false; resolveLink(); } });
        window.addEventListener('touchend', () => { if (state.isDragging) { state.isDragging = false; resolveLink(); } });

        window.addEventListener('touchstart', (e) => {
            const t = e.touches[0];
            const target = document.elementFromPoint(t.clientX, t.clientY);
            if (target?.classList.contains('grid-cell')) { e.preventDefault(); startLink(t, target); }
        }, { passive: false });
        window.addEventListener('touchmove', (e) => {
            const t = e.touches[0];
            const target = document.elementFromPoint(t.clientX, t.clientY);
            if (target?.classList.contains('grid-cell')) continueLink(e, target);
        }, { passive: false });

        window.saveProgress = saveProgress;
    </script>
</body>
</html>

